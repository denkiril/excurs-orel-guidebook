<div class="noscrolled-header">
  <div
    *ngIf="canExpandPanel"
    class="expand-button"
    (click)="toggleExpandPanel()"
  >
    <svg
      viewBox="0 0 24 8"
      xmlns="http://www.w3.org/2000/svg"
      class="expand-button__dash"
    >
      <path
        d="M2 2.00L12 2L22 2.00"
        fill="none"
        stroke-width="4"
        stroke-linecap="round"
        stroke-linejoin="round"
      ></path>
    </svg>
  </div>
</div>

<div class="scrolled-content scroller">
  <div class="search-bar">
    <exogb-search-bar (valueSubmited)="search($event)"></exogb-search-bar>
  </div>

  <div class="filter-blocks-container">
    <div
      *ngFor="let filterBlock of filterBlocks"
      class="filter-block"
      [formGroup]="form"
    >
      <exogb-filter-block
        #fb
        [formControlName]="filterBlock.name"
        [blockTitle]="filterBlock.title"
        [opened]="filterBlock.opened"
        (openedChange)="onOpenedChange($event, filterBlock)"
      >
        <div
          class="fb-content-container"
          [@openClose]="filterBlock.opened ? 'opened' : 'closed'"
          (@openClose.done)="animationDone(filterBlock)"
        >
          <div
            *ngIf="filterBlock.opened || filterBlock.showed"
            class="fb-content"
            [class.disabled]="!fb.switchedOn"
          >
            <ng-container
              *ngFor="let group of filterBlock.groups"
              [ngTemplateOutlet]="filterGroupTemplate"
              [ngTemplateOutletContext]="{ block: fb, group: group }"
            ></ng-container>
          </div>
        </div>
      </exogb-filter-block>
    </div>
  </div>

  <div
    *ngIf="(sightsService.isFetsching$ | async) === true"
    class="spinner-container"
  >
    <exogb-spinner></exogb-spinner>
  </div>

  <div
    *ngIf="(sightsService.isFetsching$ | async) !== true && showServerError"
    class="error-notification"
  >
    <p>Сервер временно недоступен. Повторите попытку позже.</p>
    <button
      type="button"
      class="primary"
      [disabled]="form.invalid"
      (click)="form.valid && emitGetSights()"
    >
      <mat-icon
        svgIcon="refresh"
        class="button-icon"
        aria-hidden="false"
        aria-label="refresh icon"
      ></mat-icon>
      Повторить
    </button>
  </div>

  <div *ngIf="sights.length && !sightForMore" class="cards-container">
    <div *ngFor="let sight of sights" class="card-container">
      <exogb-sight-card
        [sight]="sight"
        (clickMore)="setSightForMore($event)"
      ></exogb-sight-card>
    </div>
  </div>

  <exogb-sight-card-more
    *ngIf="sightForMore"
    [sight]="sightForMore"
    (closeCard)="setSightForMore(null)"
  ></exogb-sight-card-more>
</div>

<ng-template
  #filterGroupTemplate
  let-block="block"
  let-group="group"
  [formGroup]="form"
>
  <div
    class="fb-row"
    [ngClass]="{
      'not-checked': form.get(group.name)?.errors?.notChecked
    }"
    [formGroupName]="group.name"
  >
    <div *ngIf="group.title" class="fb-col-title" [title]="group.title">
      {{ group.shortTitle || group.title }}
    </div>

    <div
      *ngIf="group.controls.length"
      class="fb-cols"
      [class.is--rows]="group.title === undefined"
    >
      <div *ngFor="let control of group.controls" class="fb-col">
        <exogb-checkbox
          [formControlName]="control.name"
          [controlTitle]="control.title"
          [textRight]="control.shortTitle || control.title"
          [enabled]="block.switchedOn"
          [alert]="form.get(group.name)?.errors?.notChecked"
        ></exogb-checkbox>
      </div>
    </div>
  </div>
</ng-template>
